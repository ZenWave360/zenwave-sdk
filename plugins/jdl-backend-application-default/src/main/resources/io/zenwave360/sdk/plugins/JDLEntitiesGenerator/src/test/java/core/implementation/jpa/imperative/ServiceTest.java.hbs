package {{basePackage}}.core.implementation;

import {{basePackage}}.config.*;
import {{basePackage}}.core.domain.*;
import {{basePackage}}.core.inbound.*;
import {{basePackage}}.core.inbound.dtos.*;
import {{basePackage}}.core.implementation.mappers.*;
import {{basePackage}}.core.outbound.jpa.*;
import {{basePackage}}.infrastructure.jpa.inmemory.*;
{{#if jdl.options.options.search}}
import {{basePackage}}.core.outbound.search.*;
{{/if}}

import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.MethodOrderer;
import org.junit.jupiter.api.Order;
import org.junit.jupiter.api.Test;
import org.junit.jupiter.api.TestMethodOrder;
import org.mapstruct.factory.Mappers;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.PageRequest;

import java.util.Optional;
import java.time.*;
import java.math.BigDecimal;

import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.mockito.Mockito.*;

/**
 * Acceptance Test for {{service.name}}.
 */
@TestMethodOrder(MethodOrderer.OrderAnnotation.class)
public class {{service.name}}Test  {

    private final Logger log = LoggerFactory.getLogger(getClass());

    InMemoryTestsManualContext context = InMemoryTestsManualContext.INSTANCE;
    {{~#assign "serviceInstance"}}{{asInstanceName service.name}}{{/assign}}
    {{service.name}}Impl {{serviceInstance}} = context.{{serviceInstance}}();
{{#each entities as |entity|}}
    {{entity.className}}RepositoryInMemory {{entity.instanceName}}Repository = context.{{entity.instanceName}}Repository();
    {{~#if options.search}}
    {{entity.className}}SearchRepository {{entity.instanceName}}SearchRepository = context.{{entity.instanceName}}SearchRepository();
    {{~/if}}
{{/each}}
    @BeforeEach
    void setUp() {
        {{~#each entities as |entity|}}
        {{entity.instanceName}}Repository.clear();
        {{entity.instanceName}}Repository.save(new {{entity.className}}());
        {{~/each}}
    }

{{#each entities as |entity|}}
    // {{entity.name}}

    @Test
    @Order({{@index}}1)
    void testCRUD{{entity.className}}() {
        var input = new {{entity.className}}{{inputDTOSuffix}}();
        // TODO fill input data
        {{~#each entity.fields as |field|}}
        // input.set{{capitalize field.name}}({{{populateField field}}});
        {{~/each}}
        var {{entity.instanceName}} = {{serviceInstance}}.create{{entity.className}}(input);
        assertNotNull({{entity.instanceName}}.getId());
        assertTrue({{entity.instanceName}}Repository.containsEntity({{entity.instanceName}}));

        var id = {{entity.instanceName}}.getId();
        var {{entity.instanceName}}Update = new {{entity.className}}{{inputDTOSuffix}}();
        // TODO fill update data
        {{~#each entity.fields as |field|}}
        // {{entity.instanceName}}Update.set{{capitalize field.name}}({{{populateField field}}});
        {{~/each}}
        assertTrue({{entity.instanceName}}Repository.containsKey(id));
        var {{entity.instanceName}}Updated = {{serviceInstance}}.update{{entity.className}}(id, {{entity.instanceName}}Update);
        assertTrue({{entity.instanceName}}Updated.isPresent());
        assertTrue({{entity.instanceName}}Repository.containsEntity({{entity.instanceName}}Updated.get()));

        assertTrue({{entity.instanceName}}Repository.containsKey(id));
        {{serviceInstance}}.delete{{entity.className}}(id);
        assertFalse({{entity.instanceName}}Repository.containsKey(id));
    }

    @Test
    @Order({{@index}}2)
    void testCreate{{entity.className}}() {
        var input = new {{entity.className}}{{inputDTOSuffix}}();
        // TODO fill input data
        {{~#each entity.fields as |field|}}
        // input.set{{capitalize field.name}}({{{populateField field}}});
        {{~/each}}
        var {{entity.instanceName}} = {{serviceInstance}}.create{{entity.className}}(input);
        assertNotNull({{entity.instanceName}}.getId());
        assertTrue({{entity.instanceName}}Repository.containsEntity({{entity.instanceName}}));
    }

    @Test
    @Order({{@index}}3)
    void testUpdate{{entity.className}}() {
        var id = 0L; // TODO fill id
        var input = new {{entity.className}}{{inputDTOSuffix}}();
        // TODO fill input data
        {{~#each entity.fields as |field|}}
        // input.set{{capitalize field.name}}({{{populateField field}}});
        {{~/each}}
        assertTrue({{entity.instanceName}}Repository.containsKey(id));
        var {{entity.instanceName}} = {{serviceInstance}}.update{{entity.className}}(id, input);
        assertTrue({{entity.instanceName}}.isPresent());
        assertTrue({{entity.instanceName}}Repository.containsEntity({{entity.instanceName}}.get()));
    }

    @Test
    @Order({{@index}}4)
    void testList{{entity.classNamePlural}}() {
        var results = {{serviceInstance}}.list{{entity.classNamePlural}}(PageRequest.of(0, 10));
        assertNotNull(results);
    }

    {{#if entity.options.searchCriteria ~}}
    @Test
    @Order({{@index}}5)
    void testSearch{{entity.classNamePlural}}() {
        var criteria = new {{criteriaClassName entity}}();
        // TODO fill criteria
        var results = {{serviceInstance}}.search{{entity.classNamePlural}}(criteria, PageRequest.of(0, 10));
        assertNotNull(results);
    }
    {{~/if}}

    @Test
    @Order({{@index}}6)
    void testGet{{entity.className}}() {
        var id = 0L; // TODO fill id
        var {{entity.instanceName}} = {{serviceInstance}}.get{{entity.className}}(id);
        assertTrue({{entity.instanceName}}.isPresent());
    }

    @Test
    @Order({{@index}}7)
    void testDelete{{entity.className}}() {
        var id = 0L; // TODO fill id
        assertTrue({{entity.instanceName}}Repository.containsKey(id));
        {{serviceInstance}}.delete{{entity.className}}(id);
        assertFalse({{entity.instanceName}}Repository.containsKey(id));
    }

{{/each}}
}
