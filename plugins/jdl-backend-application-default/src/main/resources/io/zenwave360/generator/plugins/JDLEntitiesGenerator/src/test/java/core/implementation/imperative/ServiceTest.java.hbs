package {{basePackage}}.core.implementation;

import {{basePackage}}.core.domain.*;
import {{basePackage}}.core.inbound.*;
import {{basePackage}}.core.inbound.dtos.*;
import {{basePackage}}.core.implementation.mappers.*;
import {{basePackage}}.core.outbound.mongodb.*;
import {{basePackage}}.core.outbound.mongodb.inmemory.*;
{{#if jdl.options.options.search}}
import {{basePackage}}.core.outbound.search.*;
{{/if}}

import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.BeforeEach;
import org.junit.jupiter.api.Test;
import org.mockito.InjectMocks;
import org.mockito.Mock;
import org.mockito.MockitoAnnotations;
import org.mockito.Spy;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.Pageable;
import org.springframework.data.domain.PageRequest;

import java.util.Optional;

import static org.junit.jupiter.api.Assertions.assertNotNull;
import static org.junit.jupiter.api.Assertions.assertTrue;
import static org.junit.jupiter.api.Assertions.assertFalse;
import static org.mockito.Mockito.*;

/**
 * Acceptance Test for {{service.name}}.
 */
public class {{service.name}}Test  {

    private final Logger log = LoggerFactory.getLogger(getClass());

{{#each entities as |entity|}}
    @Spy
    {{entity.className}}Mapper {{entity.instanceName}}Mapper = new {{entity.className}}MapperImpl();
    @Spy
    {{entity.className}}RepositoryInMemory {{entity.instanceName}}Repository = new {{entity.className}}RepositoryInMemory();
    {{~#if options.search}}
    @Mock
    {{entity.className}}SearchRepository {{entity.instanceName}}SearchRepository;
    {{~/if}}
{{/each}}

    @InjectMocks
    {{service.name}}Impl {{service.name}};

    @BeforeEach
    void setUp() {
        MockitoAnnotations.openMocks(this);
        {{~#each entities as |entity|}}
        {{entity.instanceName}}Repository.insert(new {{entity.className}}());
        {{~/each}}
    }

{{#each entities as |entity|}}
    // {{entity.name}}

    @Test
    void testCreate{{entity.className}}() {
        var input = new {{entity.className}}{{inputDTOSuffix}}();
        // TODO fill input data
        var {{entity.instanceName}} = {{service.name}}.create{{entity.className}}(input);
        assertNotNull({{entity.instanceName}}.getId());
        assertTrue({{entity.instanceName}}Repository.containsEntity({{entity.instanceName}}));
    }

    @Test
    void testUpdate{{entity.className}}() {
        var id = "0"; // TODO fill id
        var input = new {{entity.className}}{{inputDTOSuffix}}();
        // TODO fill input data
        assertTrue({{entity.instanceName}}Repository.containsKey(id));
        var {{entity.instanceName}} = {{service.name}}.update{{entity.className}}(id, input);
        assertTrue({{entity.instanceName}}.isPresent());
        assertTrue({{entity.instanceName}}Repository.containsEntity({{entity.instanceName}}.get()));
    }

    @Test
    {{~#assign "criteria"}}{{#if entity.options.searchCriteria}}new {{criteriaClassName entity}}(){{else}}PageRequest.of(0, 10){{/if}}{{/assign}}
    void testFind{{entity.classNamePlural}}() {
        var criteria = {{criteria}};
        // TODO fill criteria
        var results = {{service.name}}.find{{entity.classNamePlural}}(criteria);
        assertNotNull(results);
    }

    @Test
    void testGet{{entity.className}}() {
        var id = "0"; // TODO fill id
        var {{entity.instanceName}} = {{service.name}}.get{{entity.className}}(id);
        assertTrue({{entity.instanceName}}.isPresent());
    }

    @Test
    void testDelete{{entity.className}}() {
        var id = "0"; // TODO fill id
        assertTrue({{entity.instanceName}}Repository.containsKey(id));
        {{service.name}}.delete{{entity.className}}(id);
        assertFalse({{entity.instanceName}}Repository.containsKey(id));
    }

{{/each}}
}
