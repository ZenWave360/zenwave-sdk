package {{layout.infrastructureRepositoryPackage}}.inmemory

import {{layout.entitiesPackage}}.*
import {{layout.outboundRepositoryPackage}}.{{entity.className}}Repository
import java.math.*
import java.time.*
import java.util.*

class {{entity.className}}RepositoryInMemory : InMemoryMongodbRepository<{{entity.className}}>(), {{entity.className}}Repository {

{{~#if (naturalIdFields entity)}}
    override {{{naturalIdsRepoMethodSignature entity}}} {
        return getEntities().values.stream().filter { e ->
            {{#joinWithTemplate (naturalIdFields entity) delimiter='&&'}} isSameValue({{name}}, readField(e, "{{name}}")) {{/joinWithTemplate}}
        }.findFirst()
    }
{{~/if}}
{{~assign 'relationships' (findOwnedOneToManyRelationships entity)}}
{{~#if relationships}}
    override fun <S : {{entity.className}}> save(entity: S): S {
        super.save(entity)
    {{~#each relationships as |relationship|}}
            entity.{{relationship.fieldName}}.forEach { it.id = it.id ?: entity.id }
    {{~/each}}
        return entity;
        }
{{~/if}}
}
