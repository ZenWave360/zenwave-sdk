package {{layout.configPackage}};

import org.springframework.core.convert.support.DefaultConversionService;
import org.springframework.data.convert.Jsr310Converters;
import org.springframework.data.mongodb.MongoManagedTypes;
import org.springframework.data.mongodb.core.convert.MappingMongoConverter;
import org.springframework.data.mongodb.core.convert.MongoCustomConversions;
import org.springframework.data.mongodb.core.convert.NoOpDbRefResolver;
import org.springframework.data.mongodb.core.mapping.MongoMappingContext;

import java.io.File;
import java.nio.file.Files;
import java.util.Collections;
import java.util.List;
import java.util.stream.Collectors;
import java.util.stream.Stream;

public class TestDataLoader {

    private List<? extends Class<?>> mongoManagedTypes;

    public TestDataLoader(List<? extends Class<?>> mongoManagedTypes) {
        this.mongoManagedTypes = mongoManagedTypes;
        mappingConverter = mappingConverter();
    }

    public <T> List<T> loadCollectionTestDataAsObjects(Class<T> collectionClass) {
        var jsonList = loadCollectionTestDataAsJson(collectionClass);
        return jsonList.stream().map(json -> read(collectionClass, json)).collect(Collectors.toList());
    }

    public List<String> loadCollectionTestDataAsJson(Class<?> collectionClass) {
        return readDirectoryFilesAsString("src/test/resources/data/mongodb/" + collectionClass.getSimpleName());
    }

    protected List<String> listFolders(String directory) {
        return Stream.of(new File(directory).listFiles()).map(File::getName).collect(Collectors.toList());
    }

    protected List<String> readDirectoryFilesAsString(String directory) {
        return Stream.of(new File(directory).listFiles()).map(f -> {
            try {
                return Files.readString(f.toPath());
            } catch (java.io.IOException e) {
                throw new RuntimeException(e);
            }
        }).collect(Collectors.toList());
    }

    public <T> T read(Class<T> type, String json) {
        return mappingConverter.read(type, org.bson.Document.parse(json));
    }

    MappingMongoConverter mappingConverter;

    MappingMongoConverter mappingConverter() {
        MappingMongoConverter mappingConverter = new MappingMongoConverter(NoOpDbRefResolver.INSTANCE, mongoMappingContext());
        DefaultConversionService conversionService = (DefaultConversionService) mappingConverter.getConversionService();
        Jsr310Converters.getConvertersToRegister().forEach(conversionService::addConverter);

        // Handle NullableWrapperConverters for different Spring Boot versions
        try {
            Class<?> nullableWrapperConverters = Class.forName("org.springframework.data.convert.NullableWrapperConverters");
            java.lang.reflect.Method registerMethod = nullableWrapperConverters.getMethod("registerConvertersIn", org.springframework.core.convert.ConversionService.class);
            registerMethod.invoke(null, conversionService);
        } catch (Exception e) {
            try {
                Class<?> nullableWrapperConverters = Class.forName("org.springframework.data.core.NullableWrapperConverters");
                java.lang.reflect.Method registerMethod = nullableWrapperConverters.getMethod("registerConvertersIn", org.springframework.core.convert.ConversionService.class);
                registerMethod.invoke(null, conversionService);
            } catch (Exception ignored) {
                // NullableWrapperConverters not available in this version
            }
        }

        conversionService.removeConvertible(Object.class, Object.class);
        return mappingConverter;
    }

    MongoMappingContext mongoMappingContext() {
        var managedTypes = MongoManagedTypes.fromIterable(mongoManagedTypes);
        MongoMappingContext context = new MongoMappingContext();
        context.setManagedTypes(managedTypes);

        var conversions = new MongoCustomConversions(Collections.emptyList());
        context.setSimpleTypeHolder(conversions.getSimpleTypeHolder());
        context.afterPropertiesSet();
        return context;
    }
}
