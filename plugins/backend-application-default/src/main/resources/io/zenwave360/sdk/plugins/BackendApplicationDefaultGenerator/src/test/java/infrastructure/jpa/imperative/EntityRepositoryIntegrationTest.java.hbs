package {{infrastructurePackage}}.jpa;

import java.util.HashSet;
import java.time.*;
import java.math.BigDecimal;

import {{entitiesPackage}}.*;
import {{basePackage}}.core.outbound.jpa.{{entity.className}}Repository;
import org.junit.jupiter.api.Assertions;
import org.junit.jupiter.api.Test;
import org.springframework.beans.factory.annotation.Autowired;

import jakarta.persistence.EntityManager;

public class {{entity.className}}RepositoryIntegrationTest extends BaseRepositoryIntegrationTest {

    @Autowired
    EntityManager entityManager;

    @Autowired
    {{entity.className}}Repository {{entity.instanceName}}Repository;

    @Test
    public void findAllTest() {
        var results = {{entity.instanceName}}Repository.findAll();
        Assertions.assertFalse(results.isEmpty());
    }


    @Test
    public void findByIdTest() {
        var id = 1L;
        var {{entity.instanceName}} = {{entity.instanceName}}Repository.findById(id).orElseThrow();
        Assertions.assertTrue({{entity.instanceName}}.getId() != null);
        Assertions.assertTrue({{entity.instanceName}}.getVersion() != null);
        {{~#if (or entity.options.auditing entity.options.extendsAuditing)}}
        Assertions.assertTrue({{entity.instanceName}}.getCreatedBy() != null);
        Assertions.assertTrue({{entity.instanceName}}.getCreatedDate() != null);
        {{~/if}}
    }

    @Test
    public void saveTest() {
        {{entity.className}} {{entity.instanceName}} = new {{entity.className}}();
        {{~#each entity.fields as |field|}}
        {{entity.instanceName}}.set{{capitalize field.name}}({{{populateField field}}});
        {{~/each}}

{{#each entity.relationships as |relationship|}}
{{~#if relationship.fieldName}}
        // {{relationship.type}} {{relationship.fieldName}} owner: {{relationship.ownerSide}}
    {{~#if (or relationship.ownerSide (and (endsWith relationship.type 'OneToOne') (not relationship.ownerSide) entity.options.aggregate) )}}
        {{~#if (and relationship.ownerSide (endsWith relationship.type 'ToOne'))}}
        var {{relationship.fieldName}}Id = 1L;
        {{~/if}}
        {{~#if (addRelationshipById relationship entity=entity)}}
        {{entity.instanceName}}.set{{capitalize relationship.fieldName}}Id({{relationship.fieldName}}Id); // using id to write relationship
        {{~else}}
        var {{relationship.fieldName}} = new {{relationship.otherEntityName}}();
        {{~assign 'otherEntity' (findEntity relationship.otherEntityName zdl)}}
        {{~#each otherEntity.fields as |field|}}
        {{relationship.fieldName}}.set{{capitalize field.name}}({{{populateField field}}});
        {{~/each}}
            {{~#if (endsWith relationship.type 'ToOne')}}
        {{entity.instanceName}}.set{{capitalize relationship.fieldName}}({{relationship.fieldName}});
            {{~else}}
        {{entity.instanceName}}.set{{capitalize relationship.fieldName}}(new HashSet<>());
        {{entity.instanceName}}.get{{capitalize relationship.fieldName}}().add({{relationship.fieldName}});
            {{~/if}}
        {{~/if}}
    {{~/if}}
{{/if~}}
{{/each}}

        // Persist aggregate root
        var created = {{entity.instanceName}}Repository.save({{entity.instanceName}});

        entityManager.refresh(created); // reloading to get relationships persisted by id
        Assertions.assertTrue(created.getId() != null);
        Assertions.assertTrue(created.getVersion() != null);
        {{~#if (or entity.options.auditing entity.options.extendsAuditing)}}
        Assertions.assertTrue(created.getCreatedBy() != null);
        Assertions.assertTrue(created.getCreatedDate() != null);
        {{~/if}}

{{#each entity.relationships as |relationship|}}
{{~#if relationship.fieldName}}
    {{~#if relationship.ownerSide}}
        {{~#if (endsWith relationship.type 'OneToOne')}}
        Assertions.assertTrue({{entity.instanceName}}.get{{capitalize relationship.fieldName}}().getId() != null);
        {{~else if (endsWith relationship.type 'ToOne')}}
        Assertions.assertTrue({{entity.instanceName}}.get{{capitalize relationship.fieldName}}().getId() == {{relationship.fieldName}}Id);
        {{~else}}
        Assertions.assertTrue({{entity.instanceName}}.get{{capitalize relationship.fieldName}}().stream().allMatch(item -> item.getId() != null));
        {{~/if}}
    {{~/if}}
{{~/if}}
{{~/each}}
    }

    @Test
    public void updateTest() {
        var id = 1L;
        var {{entity.instanceName}} = {{entity.instanceName}}Repository.findById(id).orElseThrow();
        {{~#each entity.fields as |field|}}
        {{entity.instanceName}}.set{{capitalize field.name}}({{{populateField field}}});
        {{~/each}}

        {{entity.instanceName}} = {{entity.instanceName}}Repository.save({{entity.instanceName}});
        {{~#each entity.fields as |field|}}
        Assertions.assertEquals({{{populateField field}}}, {{entity.instanceName}}.get{{capitalize field.name}}());
        {{~/each}}
    }

    @Test
    public void deleteTest() {
        var id = 1L;
        {{entity.instanceName}}Repository.deleteById(id);
        var notFound = {{entity.instanceName}}Repository.findById(id);
        Assertions.assertFalse(notFound.isPresent());
    }
}
